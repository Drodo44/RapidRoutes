# RapidRoutes Intelligence API Fix

## ðŸš¨ EMERGENCY FIX ðŸš¨

This package contains tools to fix the intelligence-pairing API by creating the required RPC function in the Supabase database.

## Problem Description

The intelligence-pairing API is failing because the required PostGIS function `find_cities_within_radius` is missing from the Supabase database. This function is essential for:

- Finding cities within a specified radius
- Generating city crawl pairs for DAT exports
- Supporting geospatial intelligence features

## Quick Fix Options

You have three options to fix the issue:

### Option 1: Interactive Fix Script (Recommended)

Run the interactive fix script that will guide you through the process:

```bash
node fix-api.mjs
```

The script will:
1. Generate the SQL file
2. Optionally connect to your Supabase instance
3. Create the RPC function
4. Test if the function is working

### Option 2: Web-Based Solution

Open the `api-fix-tool.html` file in your browser:

```bash
# Start a simple HTTP server
python3 -m http.server 8080
```

Then open http://localhost:8080/api-fix-tool.html in your browser.

This tool provides:
- Step-by-step instructions
- Copy-paste SQL code
- API testing functionality

### Option 3: Manual SQL Execution

1. Copy the SQL from `fix-intelligence-api.sql` (generated by either option above)
2. Log in to your Supabase dashboard
3. Go to the SQL Editor
4. Create a new query
5. Paste the SQL code
6. Run the query

## Verification

After applying the fix, verify that:

1. The API now returns city pairs instead of empty results
2. DAT exports contain the expected number of city pairs (22 per lane)
3. No more error messages in the browser console related to RPC functions

## Need Help?

If you continue to experience issues after applying the fix, check:

1. Database permissions for the RPC function
2. PostGIS extension installation status
3. API route implementation in `pages/api/intelligence-pairing.js`
4. Authentication token validity when testing

## Technical Details

The fix creates a PostGIS-powered function that:
- Finds cities within a specified radius using earth_distance calculation
- Filters for cities with valid latitude, longitude, and KMA code
- Orders results by distance (closest first)
- Limits results to prevent excessive returns

This is required by the intelligence-pairing API to generate valid city crawl pairs for DAT exports.

---

Fix created for RapidRoutes Â© 2023